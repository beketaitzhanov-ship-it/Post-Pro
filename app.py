# -*- coding: utf-8 -*-

# ==================================================================================================
#                                        POSTPRO CHATBOT
#                                        VERSION: 3.0.0 (MAJOR UPDATE)
#                                  LAST UPDATE: 2025-10-14
# ==================================================================================================
# –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—É—é, —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –∏ —É–ª—É—á—à–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É –¥–ª—è Flask-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–∞—Ç-–±–æ—Ç–∞ PostPro.
#
# –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏:
# 1.  –†–ê–°–ß–ï–¢ –ü–û –ü–õ–û–¢–ù–û–°–¢–ò: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Ç–æ—á–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º —Ä–∞—Å—á–µ—Ç–∞ —Ç–∞—Ä–∏—Ñ–∞ T1 –Ω–∞ –æ—Å–Ω–æ–≤–µ
#     —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è –≤–µ—Å–∞ –∏ –æ–±—ä–µ–º–∞ –≥—Ä—É–∑–∞.
# 2.  –î–ï–¢–ê–õ–¨–ù–´–ô –†–ê–°–ß–ï–¢ T2: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–ª–æ–∂–Ω–∞—è —Ç–∞—Ä–∏—Ñ–Ω–∞—è —Å–µ—Ç–∫–∞ –ö–∞–∑–ø–æ—á—Ç—ã –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏
#     –ø–æ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—É, –≤–∫–ª—é—á–∞—è –æ–±—Ä–∞–±–æ—Ç–∫—É –≥—Ä—É–∑–æ–≤ –¥–æ –∏ —Å–≤—ã—à–µ 20 –∫–≥.
# 3.  –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô –ö–£–†–° –í–ê–õ–Æ–¢: –ë–æ—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–ª—É—á–∞–µ—Ç –∫—É—Ä—Å –ø–æ–∫—É–ø–∫–∏ –¥–æ–ª–ª–∞—Ä–∞ –°–®–ê
#     —É –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ë–∞–Ω–∫–∞ –†–ö —á–µ—Ä–µ–∑ API Gemini –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ä–∞—Å—á–µ—Ç–æ–≤.
# 4.  –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –ë–ê–ó–ê –î–ê–ù–ù–´–•: –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–≤–µ–ª–∏—á–µ–Ω —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤ –∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
#     –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤.
# 5.  –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ê–õ–ò–î–ê–¶–ò–Ø: –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –≤–≤–æ–¥–∏–º—ã—Ö
#     –¥–∞–Ω–Ω—ã—Ö –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–ø–µ—á–∞—Ç–æ–∫ –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö –≥–æ—Ä–æ–¥–æ–≤.
# 6.  –ü–û–î–†–û–ë–ù–û–ï –ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–ù–ò–ï: –ö–æ–¥ —Ç—â–∞—Ç–µ–ª—å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
#     –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è.
#
# –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 1250 –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º.
# ==================================================================================================


# --- 1. –ò–ú–ü–û–†–¢ –ù–ï–û–ë–•–û–î–ò–ú–´–• –ë–ò–ë–õ–ò–û–¢–ï–ö ---
# --------------------------------------------------------------------------------------------------
# –û—Å–Ω–æ–≤–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Flask –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏.
from flask import Flask, render_template, request, jsonify, session

# –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Python.
import os                     # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
import re                     # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è–º–∏ (–ø–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–µ–∫—Å—Ç–µ).
from datetime import datetime # –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ –≤ –∑–∞—è–≤–∫–∏.
import socket                 # –î–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ IP-–∞–¥—Ä–µ—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞.
import logging                # –î–ª—è –≤–µ–¥–µ–Ω–∏—è –ª–æ–≥–æ–≤ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
from difflib import get_close_matches # –î–ª—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–ø–µ—á–∞—Ç–æ–∫ –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö –≥–æ—Ä–æ–¥–æ–≤.

# –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ Google –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é Gemini.
import google.generativeai as genai
from google.generativeai.types import GenerationConfig
from dotenv import load_dotenv      # –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π –∏–∑ .env —Ñ–∞–π–ª–∞.


# --- 2. –ù–ê–°–¢–†–û–ô–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø –ò –ì–õ–û–ë–ê–õ–¨–ù–´–• –ü–ê–†–ê–ú–ï–¢–†–û–í ---
# --------------------------------------------------------------------------------------------------

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–æ–Ω—Å–æ–ª—å.
# –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ –±–æ—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, API-–∫–ª—é—á) –∏–∑ —Ñ–∞–π–ª–∞ .env.
load_dotenv()
GEMINI_API_KEY = os.getenv("GOOGLE_API_KEY")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Flask.
app = Flask(__name__)
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ —Å–µ—Å—Å–∏–π, —á—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –∏—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
app.secret_key = os.getenv("FLASK_SECRET_KEY", 'postpro-default-super-secret-key-2025')
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (1 —á–∞—Å).
app.config['PERMANENT_SESSION_LIFETIME'] = 3600

# --- 3. –ë–ê–ó–´ –î–ê–ù–ù–´–• –ò –ö–û–ù–°–¢–ê–ù–¢–´ ---
# --------------------------------------------------------------------------------------------------
# –í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤—Å–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–æ—Ç:
# —Ç–∞—Ä–∏—Ñ–Ω—ã–µ –∑–æ–Ω—ã, —Ç–∞–º–æ–∂–µ–Ω–Ω—ã–µ —Å—Ç–∞–≤–∫–∏, –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —Ç.–¥.

# –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –±–∞–∑–∞ –≥–æ—Ä–æ–¥–æ–≤ –∏ –∏—Ö —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –∑–æ–Ω –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ T2.
# –í–∫–ª—é—á–∞–µ—Ç –æ–±–ª–∞—Å—Ç–Ω—ã–µ —Ü–µ–Ω—Ç—Ä—ã, –∫—Ä—É–ø–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ –∏ —Ä–∞–π–æ–Ω–Ω—ã–µ —Ü–µ–Ω—Ç—Ä—ã –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è.
DESTINATION_ZONES = {
    # –ó–æ–Ω–∞ 1: –ê–ª–º–∞—Ç—ã –∏ –ê–ª–º–∞—Ç–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å (—Å–∞–º–∞—è –±–ª–∏–∑–∫–∞—è –∏ –¥–µ—à–µ–≤–∞—è –∑–æ–Ω–∞)
    "–∞–ª–º–∞—Ç—ã": 1, "–∞–ª–º–∞—Ç–∞": 1, "—Ç–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω": 1, "–∫–æ–Ω–∞–µ–≤": 1, "–∫–∞–ø—á–∞–≥–∞–π": 1, "—Ç–µ–∫–µ–ª–∏": 1,
    "–µ—Å–∏–∫": 1, "—Ç–∞–ª–≥–∞—Ä": 1, "–∫–∞—Å–∫–µ–ª–µ–Ω": 1, "–∂–∞—Ä–∫–µ–Ω—Ç": 1, "—Å–∞—Ä–∫–∞–Ω–¥": 1, "—É—à–∞—Ä–∞–ª": 1,
    "—É–∑—ã–Ω–∞–≥–∞—à": 1, "—à–µ–ª–µ–∫": 1, "–∫–µ–≥–µ–Ω": 1, "–Ω–∞—Ä—ã–Ω–∫–æ–ª": 1, "—Ñ–∞–±—Ä–∏—á–Ω—ã–π": 1, "–æ—Ç–µ–≥–µ–Ω-–±–∞—Ç—ã—Ä": 1,

    # –ó–æ–Ω–∞ 2: –Æ–∂–Ω—ã–π –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω (—Å—Ä–µ–¥–Ω—è—è —É–¥–∞–ª–µ–Ω–Ω–æ—Å—Ç—å)
    "—Ç–∞—Ä–∞–∑": 2, "—à—ã–º–∫–µ–Ω—Ç": 2, "—Ç—É—Ä–∫–µ—Å—Ç–∞–Ω": 2, "–∞—É–ª–∏–µ–∞—Ç–∞": 2, "–∫–æ—Ä–¥–∞–π": 2, "–º–µ—Ä–∫–µ": 2,
    "–º–æ–π—ã–Ω–∫—É–º": 2, "–∂–∞–Ω–∞—Ç–∞—Å": 2, "–∫–∞—Ä–∞—Ç–∞—É": 2, "—à—É": 2, "—Å–∞—Ä—ã–∞–≥–∞—à": 2, "–∂–µ—Ç—ã—Å–∞–π": 2,
    "–ª–µ–Ω–≥–µ—Ä": 2, "–∞—Ä—ã—Å": 2, "—à–∞—Ä–¥–∞—Ä–∞": 2, "–∞—Ç–∞–∫–µ–Ω—Ç": 2, "–∞—Å—ã–∫–∞—Ç–∞": 2,

    # –ó–æ–Ω–∞ 3: –¶–µ–Ω—Ç—Ä, –°–µ–≤–µ—Ä –∏ –í–æ—Å—Ç–æ–∫ (–¥–∞–ª—å–Ω—è—è —É–¥–∞–ª–µ–Ω–Ω–æ—Å—Ç—å)
    "–∞—Å—Ç–∞–Ω–∞": 3, "–∫–∞—Ä–∞–≥–∞–Ω–¥–∞": 3, "–Ω—É—Ä-—Å—É–ª—Ç–∞–Ω": 3, "–∫–æ–∫—à–µ—Ç–∞—É": 3, "—Å—Ç–µ–ø–Ω–æ–≥–æ—Ä—Å–∫": 3,
    "–∞—Ç–±–∞—Å–∞—Ä": 3, "–µ—Ä–µ–π–º–µ–Ω—Ç–∞—É": 3, "–º–∞–∫–∏–Ω—Å–∫": 3, "—â—É—á–∏–Ω—Å–∫": 3, "–±–∞–ª—Ö–∞—à": 3, "—Ç–µ–º–∏—Ä—Ç–∞—É": 3,
    "—à–∞—Ö—Ç–∏–Ω—Å–∫": 3, "–∂–µ–∑–∫–∞–∑–≥–∞–Ω": 3, "—Å–∞—Ç–ø–∞–µ–≤": 3, "—Å–∞—Ä–∞–Ω—å": 3, "–∞–±–∞–π": 3,
    "–∫—ã–∑—ã–ª–æ—Ä–¥–∞": 3, "–∫–∞–∑–∞–ª—ã": 3, "–∂–∞–Ω–∞–∫–æ—Ä–≥–∞–Ω": 3, "–∞—Ä–∞–ª—å—Å–∫": 3, "–±–∞–π–∫–æ–Ω—É—Ä": 3,
    "–ø–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫": 3, "–±—É–ª–∞–µ–≤–æ": 3, "–º–∞–º–ª—é—Ç–∫–∞": 3, "—Ç–∞–π—ã–Ω—à–∞": 3,
    "–ø–∞–≤–ª–æ–¥–∞—Ä": 3, "—ç–∫–∏–±–∞—Å—Ç—É–∑": 3, "–∞–∫—Å—É": 3,
    "–∫–æ—Å—Ç–∞–Ω–∞–π": 3, "—Ä—É–¥–Ω—ã–π": 3, "–ª–∏—Å–∞–∫–æ–≤—Å–∫": 3, "–∞—Ä–∫–∞–ª—ã–∫": 3, "–∂–µ—Ç—ã–∫–∞—Ä–∞": 3, "—Ç–æ–±–æ–ª": 3,
    "—Å–µ–º–µ–π": 3, "—É—Å—Ç—å-–∫–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫": 3, "–æ—Å–∫–µ–º–µ–Ω": 3, "—Ä–∏–¥–¥–µ—Ä": 3, "–∫—É—Ä—á–∞—Ç–æ–≤": 3,
    "–∞—è–≥–æ–∑": 3, "—à–∞—Ä": 3, "–∑–∞–π—Å–∞–Ω": 3, "–∞–ª—Ç–∞–π": 3, "—à–µ–º–æ–Ω–∞–∏—Ö–∞": 3,

    # –ó–æ–Ω–∞ 4: –ó–∞–ø–∞–¥–Ω—ã–π –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω (–æ—á–µ–Ω—å –¥–∞–ª—å–Ω—è—è —É–¥–∞–ª–µ–Ω–Ω–æ—Å—Ç—å)
    "–∞–∫—Ç–æ–±–µ": 4, "—Ö—Ä–æ–º—Ç–∞—É": 4, "—à–∞–ª–∫–∞—Ä": 4, "–∫–∞–Ω–¥—ã–∞–≥–∞—à": 4, "—ç–º–±–∞": 4,
    "—É—Ä–∞–ª—å—Å–∫": 4, "–æ—Ä–∞–ª": 4, "–∞–∫—Å–∞–π": 4, "–¥–∞—Ä—å–∏–Ω—Å–∫–æ–µ": 4, "–∂–∞–Ω–≥–∞–ª–∞": 4,

    # –ó–æ–Ω–∞ 5: –ù–µ—Ñ—Ç–µ–≥–∞–∑–æ–≤—ã–π —Ä–µ–≥–∏–æ–Ω (—Å–∞–º–∞—è –¥–∞–ª—å–Ω—è—è –∏ –¥–æ—Ä–æ–≥–∞—è –∑–æ–Ω–∞)
    "–∞—Ç—ã—Ä–∞—É": 5, "–∫—É–ª—å—Å–∞—Ä—ã": 5, "–º–∞–∫–∞—Ç": 5, "–∏–Ω–¥–µ—Ä–±–æ—Ä—Å–∫–∏–π": 5,
    "–∞–∫—Ç–∞—É": 5, "–∂–∞–Ω–∞–æ–∑–µ–Ω": 5, "–±–µ–π–Ω–µ—É": 5, "—Ñ–æ—Ä—Ç-—à–µ–≤—á–µ–Ω–∫–æ": 5, "—à–µ—Ç–ø–µ": 5, "–º–∞–Ω–≥–∏—Å—Ç–∞—É": 5
}

# –¢–∞–º–æ–∂–µ–Ω–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ –ø–æ—à–ª–∏–Ω—ã –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ç–æ–≤–∞—Ä–æ–≤.
CUSTOMS_RATES = {
    "–æ–¥–µ–∂–¥–∞": 10, "—ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞": 5, "–∫–æ—Å–º–µ—Ç–∏–∫–∞": 15, "—Ç–µ—Ö–Ω–∏–∫–∞": 5,
    "–º–µ–±–µ–ª—å": 10, "–∞–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç–∏": 5, "–æ–±—â–∏–µ —Ç–æ–≤–∞—Ä—ã": 10, "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã": 8,
    "—Ç–∫–∞–Ω–∏": 12, "–ø–æ—Å—É–¥–∞": 10, "–ø—Ä–æ–¥—É–∫—Ç—ã": 15, "–ª–µ–∫–∞—Ä—Å—Ç–≤–∞": 0, "–±–µ–ª—å–µ": 12,
    "–∏–≥—Ä—É—à–∫–∏": 5, "–≤–µ—â–∏": 10, '—Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª—ã': 10, '–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ': 5, '–ª–∞–º–ø—ã': 8,
    '–∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤': 5, '–≥–æ–ª–æ–≤–Ω—ã–µ —É–±–æ—Ä—ã': 10, '—Å—É–º–∫–∏': 10, '–º–∞–ª–∞—è —Ç–µ—Ö–Ω–∏–∫–∞': 5,
    '—á–∞–π': 15, '—Ç–µ–∫—Å—Ç–∏–ª—å': 12, '–ø–æ—Å—Ç–µ–ª—å–Ω–æ–µ –±–µ–ª—å–µ': 12, '–ø–æ–ª–æ—Ç–µ–Ω—Ü–∞': 12, '–æ–¥–µ—è–ª–∞': 12,
    '–º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã': 0
}

# –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–º–æ–∂–µ–Ω–Ω—ã–µ —Å–±–æ—Ä—ã –≤ —Ç–µ–Ω–≥–µ.
CUSTOMS_FEES = {
    "–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ": 15000,
    "—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç": 120000,
    "–±—Ä–æ–∫–µ—Ä": 60000,
    "–¥–µ–∫–ª–∞—Ä–∞—Ü–∏—è": 15000
}

# –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
GREETINGS = ["–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "—Å–∞–ª–µ–º", "—Å”ô–ª–µ–º", "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å", "–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä", "–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ"]

# --- 4. –°–ò–°–¢–ï–ú–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ò GEMINI ---
# --------------------------------------------------------------------------------------------------
# –≠—Ç–∏ "–ø—Ä–æ–º—Ç—ã" –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç, –∫–∞–∫ Gemini –±—É–¥–µ—Ç —Å–µ–±—è –≤–µ—Å—Ç–∏ –∏ –≤ –∫–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –æ—Ç–≤–µ—á–∞—Ç—å.

# –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –µ–≥–æ —Ä–æ–ª—å, –ø—Ä–∞–≤–∏–ª–∞ –∏ —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è.
MAIN_SYSTEM_INSTRUCTION = """
–¢—ã ‚Äî –≤–µ–∂–ª–∏–≤—ã–π –∏ –≤—ã—Å–æ–∫–æ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –ª–æ–≥–∏—Å—Ç–∏–∫–µ –≤ –∫–æ–º–ø–∞–Ω–∏–∏ PostPro. –¢–≤–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ—á—å –∫–ª–∏–µ–Ω—Ç—É —Ç–æ—á–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ –∏, –µ—Å–ª–∏ –æ–Ω –∑–∞—Ö–æ—á–µ—Ç, –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É.

***–¢–í–û–ò –ö–õ–Æ–ß–ï–í–´–ï –ü–†–ê–í–ò–õ–ê:***

1.  **–ó–û–õ–û–¢–û–ï –ü–†–ê–í–ò–õ–û –†–ê–°–ß–ï–¢–ê:** –î–ª—è –ª—é–±–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ —Ç—ã **–≤—Å–µ–≥–¥–∞** –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å **–í–ï–°** –∏ **–û–ë–™–ï–ú** (–∏–ª–∏ –≥–∞–±–∞—Ä–∏—Ç—ã –î√ó–®√ó–í). –ë–µ–∑ —ç—Ç–∏—Ö –¥–≤—É—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ç–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω. –í—Å–µ–≥–¥–∞ –≤–µ–∂–ª–∏–≤–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–π –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ. –†–∞—Å—á–µ—Ç –≤–µ–¥–µ—Ç—Å—è –ø–æ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ (–≤–µ—Å/–æ–±—ä–µ–º).

2.  **–¢–ò–ü–´ –î–û–°–¢–ê–í–ö–ò:**
    * **–ö–ê–†–ì–û:** –î–ª—è –ª–∏—á–Ω—ã—Ö –≤–µ—â–µ–π, –æ–±—Ä–∞–∑—Ü–æ–≤, –Ω–µ–±–æ–ª—å—à–∏—Ö –ø–∞—Ä—Ç–∏–π. –ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞.
    * **–ò–ù–í–û–ô–°:** –î–ª—è –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø–∞—Ä—Ç–∏–π, —Ç—Ä–µ–±—É—é—â–∏—Ö –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ç–∞–º–æ–∂–µ–Ω–Ω–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è. –î–ª—è —ç—Ç–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** –Ω—É–∂–Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–æ–≤ (–∏–Ω–≤–æ–π—Å) –≤ USD –∏ –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –∫–æ–¥ –¢–ù –í–≠–î.

3.  **–≠–¢–ê–ü–´ –î–ò–ê–õ–û–ì–ê:**
    * **–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö:** –°–æ–±–µ—Ä–∏ –≤–µ—Å, –æ–±—ä–µ–º, —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞, –≥–æ—Ä–æ–¥. –ï—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è USD –∏–ª–∏ "–∏–Ω–≤–æ–π—Å" ‚Äî –∑–∞–ø—Ä–æ—Å–∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ –∫–æ–¥ –¢–ù –í–≠–î.
    * **–†–∞—Å—á–µ—Ç –∏ –≤—ã–±–æ—Ä:** –ü–æ—Å–ª–µ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –∫–ª–∏–µ–Ω—Ç—É 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –Ω–∞ –≤—ã–±–æ—Ä: "–¥–æ –ê–ª–º–∞—Ç—ã" –∏ "–¥–æ –¥–≤–µ—Ä–∏".
    * **–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ:** –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç –≤—ã–±–µ—Ä–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç (–Ω–∞–ø–∏—Å–∞–≤ "1" –∏–ª–∏ "2"), –ø—Ä–µ–¥–ª–æ–∂–∏ –µ–º—É –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É, –∑–∞–ø—Ä–æ—Å–∏–≤ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω.

4.  **–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:**
    * –ë—É–¥—å –ø—Ä–µ–¥–µ–ª—å–Ω–æ —è—Å–Ω—ã–º, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º.
    * –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–¥–∞–µ—Ç –æ—Ç–≤–ª–µ—á–µ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –æ—Ç–≤–µ—Ç—å –Ω–∞ –Ω–µ–≥–æ –∫—Ä–∞—Ç–∫–æ –∏ –≤–µ–∂–ª–∏–≤–æ, –∞ –∑–∞—Ç–µ–º –≤–µ—Ä–Ω–∏ –µ–≥–æ –∫ –ø—Ä–æ—Ü–µ—Å—Å—É —Ä–∞—Å—á–µ—Ç–∞. –ù–∞–ø—Ä–∏–º–µ—Ä: "–î–∞, –Ω–∞—à–∏ —Å–∫–ª–∞–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç... –ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞—Å—á–µ—Ç, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –¥–æ—Å—Ç–∞–≤–∫–∏: 1 –∏–ª–∏ 2".
    * –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ (üöö, üì¶, üí°, üí∞, ‚úÖ).
"""

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–µ–π –∫–æ–¥ –¢–ù –í–≠–î. –¢—Ä–µ–±—É–µ—Ç —Å—Ç—Ä–æ–≥–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞.
CUSTOMS_SYSTEM_INSTRUCTION = """
–¢—ã ‚Äî —É–∑–∫–æ—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ò–ò, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–æ–¥–∞–º –¢–ù –í–≠–î –ï–ê–≠–°. –¢–≤–æ—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –≤–µ—Ä–Ω—É—Ç—å —Ç–æ—á–Ω—ã–π 10-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –¥–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞.

***–°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø –û–¢–í–ï–¢–ê:***
-   –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å **–¢–û–õ–¨–ö–û** 10 —Ü–∏—Ñ—Ä –∫–æ–¥–∞.
-   **–ù–ò–ö–ê–ö–ò–•** –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤, –ø–æ—è—Å–Ω–µ–Ω–∏–π, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –∏–ª–∏ –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è.
-   **–ù–ò–ö–ê–ö–ò–•** –ø—Ä–æ–±–µ–ª–æ–≤. –¢–æ–ª—å–∫–æ 10 —Ü–∏—Ñ—Ä.
-   –ï—Å–ª–∏ —Ç—ã –Ω–µ –Ω–∞ 100% —É–≤–µ—Ä–µ–Ω –≤ –∫–æ–¥–µ, –≤–µ—Ä–Ω–∏ –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω—ã–π –∫–æ–¥ –¥–ª—è –æ–±—â–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–∞.

–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Ç–≤–æ–∏—Ö **–ò–î–ï–ê–õ–¨–ù–´–•** –æ—Ç–≤–µ—Ç–æ–≤:
-   –ó–∞–ø—Ä–æ—Å: "–∏–≥—Ä—É—à–∫–∏" -> –û—Ç–≤–µ—Ç: "9503007000"
-   –ó–∞–ø—Ä–æ—Å: "–º—É–∂—Å–∫–∏–µ —Ñ—É—Ç–±–æ–ª–∫–∏ –∏–∑ —Ö–ª–æ–ø–∫–∞" -> –û—Ç–≤–µ—Ç: "6109100000"
-   –ó–∞–ø—Ä–æ—Å: "—Å–º–∞—Ä—Ç—Ñ–æ–Ω" -> –û—Ç–≤–µ—Ç: "8517120000"
-   –ó–∞–ø—Ä–æ—Å: "–æ–±—â–∏–µ —Ç–æ–≤–∞—Ä—ã" -> –û—Ç–≤–µ—Ç: "3926909709"
"""

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏, –ø–æ–ª—É—á–∞—é—â–µ–π –∫—É—Ä—Å –≤–∞–ª—é—Ç.
EXCHANGE_RATE_SYSTEM_INSTRUCTION = """
–¢—ã ‚Äî —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∫—É—Ä—Å –ø–æ–∫—É–ø–∫–∏ –¥–æ–ª–ª–∞—Ä–∞ –°–®–ê –∫ —Ç–µ–Ω–≥–µ –ø–æ –¥–∞–Ω–Ω—ã–º –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ë–∞–Ω–∫–∞ –†–ö.

***–ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–ê:***
-   –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å **–¢–û–õ–¨–ö–û** —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞.
-   –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ—á–∫—É –≤ –∫–∞—á–µ—Å—Ç–≤–µ –¥–µ—Å—è—Ç–∏—á–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è.
-   **–ù–ò–ö–ê–ö–ò–•** –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤, —Å–∏–º–≤–æ–ª–æ–≤ –≤–∞–ª—é—Ç, –ø–æ—è—Å–Ω–µ–Ω–∏–π.

–ü—Ä–∏–º–µ—Ä **–ò–î–ï–ê–õ–¨–ù–û–ì–û** –æ—Ç–≤–µ—Ç–∞: "445.50"
"""


# --- 5. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
# --------------------------------------------------------------------------------------------------

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π Gemini.
main_model = None
customs_model = None
exchange_rate_model = None # –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –∫—É—Ä—Å–∞

def initialize_models():
    """
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –≥–µ–Ω–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏ Gemini.
    –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤.
    """
    global main_model, customs_model, exchange_rate_model
    try:
        if GEMINI_API_KEY:
            genai.configure(api_key=GEMINI_API_KEY)
            # –û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –≤–µ–¥–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
            main_model = genai.GenerativeModel(
                model_name='models/gemini-1.5-flash',
                system_instruction=MAIN_SYSTEM_INSTRUCTION
            )
            # –ú–æ–¥–µ–ª—å –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–¥–æ–≤ –¢–ù –í–≠–î
            customs_model = genai.GenerativeModel(
                model_name='models/gemini-1.5-flash',
                system_instruction=CUSTOMS_SYSTEM_INSTRUCTION
            )
            # –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç
            exchange_rate_model = genai.GenerativeModel(
                model_name='models/gemini-1.5-flash',
                system_instruction=EXCHANGE_RATE_SYSTEM_INSTRUCTION
            )
            logger.info(">>> –í—Å–µ –º–æ–¥–µ–ª–∏ Gemini (Main, Customs, Exchange Rate) —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.")
            return True
        else:
            logger.error("!!! –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ö–ª—é—á GOOGLE_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ.")
            return False
    except Exception as e:
        logger.error(f"!!! –ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Gemini: {e}")
        return False

def find_closest_city(city_name):
    """
    –ù–∞—Ö–æ–¥–∏—Ç –Ω–∞–∏–±–æ–ª–µ–µ –±–ª–∏–∑–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –∏–∑ –±–∞–∑—ã DESTINATION_ZONES,
    –∏—Å–ø–æ–ª—å–∑—É—è –±–∏–±–ª–∏–æ—Ç–µ–∫—É difflib –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–ø–µ—á–∞—Ç–æ–∫.

    Args:
        city_name (str): –ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞, –≤–≤–µ–¥–µ–Ω–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.

    Returns:
        str or None: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –∏–ª–∏ None, –µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ—Ç.
    """
    if not city_name or not isinstance(city_name, str):
        return None
    all_cities = list(DESTINATION_ZONES.keys())
    # –ò—â–µ–º –æ–¥–Ω–æ –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –ø–æ—Ä–æ–≥–æ–º —Å—Ö–æ–∂–µ—Å—Ç–∏ 70%
    matches = get_close_matches(city_name.lower(), all_cities, n=1, cutoff=0.7)
    return matches[0] if matches else None


def get_current_exchange_rate():
    """
    –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –ø–æ–∫—É–ø–∫–∏ USD/KZT —á–µ—Ä–µ–∑ –º–æ–¥–µ–ª—å Gemini.
    –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.

    Returns:
        float: –ê–∫—Ç—É–∞–ª—å–Ω—ã–π –∏–ª–∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫—É—Ä—Å –æ–±–º–µ–Ω–∞.
    """
    if not exchange_rate_model:
        logger.warning("–ú–æ–¥–µ–ª—å –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫—É—Ä—Å.")
        return 450.0  # –†–µ–∑–µ—Ä–≤–Ω—ã–π –∫—É—Ä—Å

    try:
        prompt = "–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å –ø–æ–∫—É–ø–∫–∏ –¥–æ–ª–ª–∞—Ä–∞ –°–®–ê –∫ —Ç–µ–Ω–≥–µ –ø–æ –¥–∞–Ω–Ω—ã–º –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ë–∞–Ω–∫–∞ –†–ö"
        response = exchange_rate_model.generate_content(prompt)
        # –û—á–∏—Å—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ
        rate_str = re.sub(r'[^\d,.]', '', response.text)
        rate_str = rate_str.replace(',', '.')
        rate = float(rate_str)
        logger.info(f"–ü–æ–ª—É—á–µ–Ω –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –ù–ë –†–ö: {rate}")
        return rate
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç —á–µ—Ä–µ–∑ Gemini: {e}. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫—É—Ä—Å.")
        return 450.0 # –†–µ–∑–µ—Ä–≤–Ω—ã–π –∫—É—Ä—Å –≤ —Å–ª—É—á–∞–µ –ª—é–±–æ–π –æ—à–∏–±–∫–∏

def is_delivery_choice(message):
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã–±–æ—Ä–æ–º –≤–∞—Ä–∏–∞–Ω—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "1" –∏–ª–∏ "2").

    Args:
        message (str): –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    Returns:
        bool: True, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è –≤—ã–±–æ—Ä–æ–º, –∏–Ω–∞—á–µ False.
    """
    message_lower = message.lower().strip()
    choices = ['1', '2', '—Ç1', '—Ç2', 't1', 't2', '–ø–µ—Ä–≤—ã–π', '–≤—Ç–æ—Ä–æ–π', '–æ–¥–∏–Ω', '–¥–≤–∞']
    return message_lower in choices

def parse_delivery_choice(message):
    """
    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞ ("1", "–ø–µ—Ä–≤—ã–π" –∏ —Ç.–¥.)
    –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ("—Å–∞–º–æ–≤—ã–≤–æ–∑" –∏–ª–∏ "–¥–æ –¥–≤–µ—Ä–∏").

    Args:
        message (str): –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    Returns:
        str or None: –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –∏–ª–∏ None, –µ—Å–ª–∏ –≤–≤–æ–¥ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω.
    """
    message_lower = message.lower().strip()
    if message_lower in ['1', '—Ç1', 't1', '–ø–µ—Ä–≤—ã–π', '–æ–¥–∏–Ω']:
        return "—Å–∞–º–æ–≤—ã–≤–æ–∑"
    elif message_lower in ['2', '—Ç2', 't2', '–≤—Ç–æ—Ä–æ–π', '–¥–≤–∞']:
        return "–¥–æ –¥–≤–µ—Ä–∏"
    else:
        return None

def doesnt_know_tnved(message):
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –Ω–µ –∑–Ω–∞–µ—Ç –∫–æ–¥ –¢–ù–í–≠–î, –ø–æ —à–∏—Ä–æ–∫–æ–º—É —Å–ø–∏—Å–∫—É –∫–ª—é—á–µ–≤—ã—Ö —Ñ—Ä–∞–∑.

    Args:
        message (str): –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    Returns:
        bool: True, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—Ä–∞–∂–∞–µ—Ç –Ω–µ–∑–Ω–∞–Ω–∏–µ –∫–æ–¥–∞, –∏–Ω–∞—á–µ False.
    """
    patterns = [
        '–Ω–µ –∑–Ω–∞—é', '–Ω–µ—Ç –∫–æ–¥–∞', '–Ω–µ –ø–æ–º–Ω—é', '–ø–æ–¥—Å–∫–∞–∂–∏—Ç–µ', '–ø–æ–º–æ–≥–∏—Ç–µ', '–∫–∞–∫–æ–π –∫–æ–¥',
        '—á—Ç–æ —É–∫–∞–∑—ã–≤–∞—Ç—å', '–≥–¥–µ –≤–∑—è—Ç—å', '–∫–∞–∫ —É–∑–Ω–∞—Ç—å', '–æ–ø—Ä–µ–¥–µ–ª–∏ –∫–æ–¥', '–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏',
        '—Å–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏', '–Ω–µ—Ç', '–Ω–µ –∏–º–µ—é', '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç', '–∑–∞–±—ã–ª', '–±–µ–∑ –∫–æ–¥–∞',
        '—á—Ç–æ —Ç–∞–∫–æ–µ —Ç–Ω–≤–µ–¥', '–ø—Ä–æ–ø—É—Å—Ç–∏', '–¥–∞–ª—å—à–µ', '–Ω–µ –≤–∞–∂–Ω–æ', '—Å–æ–º–Ω–µ–≤–∞—é—Å—å', '—Ö–∑'
    ]
    message_lower = message.lower().strip()
    return any(pattern in message_lower for pattern in patterns)


# --- 6. –§–£–ù–ö–¶–ò–ò –í–ê–õ–ò–î–ê–¶–ò–ò –í–í–û–î–ê ---
# --------------------------------------------------------------------------------------------------

def validate_weight_volume(value):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–µ—Å–∞ –∏–ª–∏ –æ–±—ä–µ–º–∞ —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –≤ —Ä–∞–∑—É–º–Ω—ã—Ö –ø—Ä–µ–¥–µ–ª–∞—Ö).

    Args:
        value (any): –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.

    Returns:
        bool: True, –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –∏–Ω–∞—á–µ False.
    """
    if value is None:
        return False
    try:
        num_value = float(value)
        # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —á–∏—Å–ª–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –∏ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç —Ä–∞–∑—É–º–Ω—ã–π –ª–∏–º–∏—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–µ—Å —Ñ—É—Ä—ã)
        if 0 < num_value < 100000:
            return True
        return False
    except (ValueError, TypeError):
        return False

def validate_phone_number(phone_str):
    """
    –°—Ç—Ä–æ–≥–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞.
    –ü—Ä–∏–≤–æ–¥–∏—Ç –Ω–æ–º–µ—Ä –∫ –µ–¥–∏–Ω–æ–º—É –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É 77...

    Args:
        phone_str (str): –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.

    Returns:
        str or None: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –∏–ª–∏ None, –µ—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.
    """
    if not isinstance(phone_str, str):
        return None

    # –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è —á–∏—Å—Ç–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    cleaned_phone = re.sub(r'\D', '', phone_str)

    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–ª—É—á–∞–∏ –¥–ª—è –Ω–æ–º–µ—Ä–æ–≤ –≤ –†–ö
    if cleaned_phone.startswith('8') and len(cleaned_phone) == 11:
        return '7' + cleaned_phone[1:]
    elif cleaned_phone.startswith('7') and len(cleaned_phone) == 11:
        return cleaned_phone
    # –ï—Å–ª–∏ –≤–≤–µ–ª–∏ 10 —Ü–∏—Ñ—Ä (–±–µ–∑ 7 –∏–ª–∏ 8 –≤ –Ω–∞—á–∞–ª–µ)
    elif len(cleaned_phone) == 10:
        return '7' + cleaned_phone

    return None # –ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–æ –∏–∑ —É—Å–ª–æ–≤–∏–π –Ω–µ –ø–æ–¥–æ—à–ª–æ


# --- 7. –§–£–ù–ö–¶–ò–ò –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø –î–ê–ù–ù–´–• (PARSING) ---
# --------------------------------------------------------------------------------------------------

def extract_delivery_info(text):
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞:
    –≤–µ—Å, –æ–±—ä–µ–º, –≥–∞–±–∞—Ä–∏—Ç—ã, –≥–æ—Ä–æ–¥, —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞.

    Args:
        text (str): –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    Returns:
        dict: –°–ª–æ–≤–∞—Ä—å —Å –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
    """
    data = {}
    text_lower = text.lower()

    # 1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤–µ—Å–∞
    weight_match = re.search(r'(\d+[,.]?\d*)\s*(–∫–≥|kg|–∫–∏–ª–æ–≥—Ä–∞–º–º)', text_lower)
    if weight_match:
        weight = float(weight_match.group(1).replace(',', '.'))
        if validate_weight_volume(weight):
            data['weight'] = weight

    # 2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –æ–±—ä–µ–º–∞ (–∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –≥–∞–±–∞—Ä–∏—Ç–∞–º–∏)
    volume_match = re.search(r'(\d+[,.]?\d*)\s*(–º¬≥|m¬≥|–º3|m3|–∫—É–±)', text_lower)
    if volume_match:
        volume = float(volume_match.group(1).replace(',', '.'))
        if validate_weight_volume(volume):
            data['volume'] = volume

    # 3. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≥–∞–±–∞—Ä–∏—Ç–æ–≤ (–î—Ö–®—Ö–í –≤ —Å–º) –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ –º¬≥, –µ—Å–ª–∏ –æ–±—ä–µ–º –µ—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω
    dims_match = re.search(r'(\d+)\s*[—Öx√ó*]\s*(\d+)\s*[—Öx√ó*]\s*(\d+)\s*(—Å–º|cm)?', text_lower)
    if dims_match and 'volume' not in data:
        l, w, h = map(int, dims_match.groups()[:3])
        if l > 0 and w > 0 and h > 0:
            volume = (l * w * h) / 1_000_000
            if validate_weight_volume(volume):
                data['volume'] = volume
                data['dimensions_str'] = f"{l}x{w}x{h} —Å–º"

    # 4. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –æ–ø–µ—á–∞—Ç–æ–∫
    words = re.split(r'[\s,.]+', text_lower)
    for word in words:
        corrected_city = find_closest_city(word)
        if corrected_city:
            data['city'] = corrected_city
            break

    # 5. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–∏–ø–∞ —Ç–æ–≤–∞—Ä–∞
    product_keywords = {
        '–º–µ–±–µ–ª—å': ['–º–µ–±–µ–ª—å', '—Å—Ç–æ–ª', '—Å—Ç—É–ª', '–∫—Ä–æ–≤–∞—Ç—å', '–¥–∏–≤–∞–Ω'],
        '—Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª—ã': ['—Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª—ã', '–ø–ª–∏—Ç–∫–∞', '–ª–∞–º–∏–Ω–∞—Ç', '–æ–±–æ–∏'],
        '–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ': ['–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', '—Å—Ç–∞–Ω–æ–∫', '–∞–ø–ø–∞—Ä–∞—Ç'],
        '–ø–æ—Å—É–¥–∞': ['–ø–æ—Å—É–¥–∞', '—Ç–∞—Ä–µ–ª–∫–∏', '—á–∞—à–∫–∏', '–∫–∞—Å—Ç—Ä—é–ª–∏'],
        '–ª–∞–º–ø—ã': ['–ª–∞–º–ø—ã', '–ª—é—Å—Ç—Ä—ã', '—Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏'],
        '–∞–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç–∏': ['–∞–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç–∏', '–∑–∞–ø—á–∞—Å—Ç–∏', '–¥–µ—Ç–∞–ª–∏ –∞–≤—Ç–æ'],
        '–∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤': ['–∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è —Ç–µ–ª–µ', '—á–µ—Ö–ª—ã', '–∑–∞—Ä—è–¥–∫–∏'],
        '–∫–æ—Å–º–µ—Ç–∏–∫–∞': ['–∫–æ—Å–º–µ—Ç–∏–∫–∞', '–∫—Ä–µ–º', '—à–∞–º–ø—É–Ω—å', '–ø–∞—Ä—Ñ—é–º'],
        '–≥–æ–ª–æ–≤–Ω—ã–µ —É–±–æ—Ä—ã': ['–≥–æ–ª–æ–≤–Ω—ã–µ —É–±–æ—Ä—ã', '—à–∞–ø–∫–∏', '–∫–µ–ø–∫–∏'],
        '—Å—É–º–∫–∏': ['—Å—É–º–∫–∏', '—Ä—é–∫–∑–∞–∫–∏', '—á–µ–º–æ–¥–∞–Ω—ã'],
        '–º–∞–ª–∞—è —Ç–µ—Ö–Ω–∏–∫–∞': ['–º–∞–ª–∞—è —Ç–µ—Ö–Ω–∏–∫–∞', '–º–∏–∫—Å–µ—Ä', '–±–ª–µ–Ω–¥–µ—Ä', '—á–∞–π–Ω–∏–∫'],
        '–ø—Ä–æ–¥—É–∫—Ç—ã': ['–ø—Ä–æ–¥—É–∫—Ç—ã', '–µ–¥–∞', '–∫–æ–Ω—Å–µ—Ä–≤—ã'],
        '—á–∞–π': ['—á–∞–π'],
        '—Ç–∫–∞–Ω–∏': ['—Ç–∫–∞–Ω–∏', '—Ç–µ–∫—Å—Ç–∏–ª—å', '—Ä—É–ª–æ–Ω—ã'],
        '–æ–¥–µ–∂–¥–∞': ['–æ–¥–µ–∂–¥–∞', '–æ–¥–µ–∂–¥', '—à—Ç–∞–Ω—ã', '—Ñ—É—Ç–±–æ–ª–∫–∏', '–∫—É—Ä—Ç–∫–∏'],
        '–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã': ['–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã', '–¥—Ä–µ–ª—å', '—à—É—Ä—É–ø–æ–≤–µ—Ä—Ç'],
        '–±–µ–ª—å–µ': ['–±–µ–ª—å–µ', '–Ω–∏–∂–Ω–µ–µ –±–µ–ª—å–µ'],
        '–ø–æ—Å—Ç–µ–ª—å–Ω–æ–µ –±–µ–ª—å–µ': ['–ø–æ—Å—Ç–µ–ª—å–Ω–æ–µ –±–µ–ª—å–µ', '–ø—Ä–æ—Å—Ç—ã–Ω–∏', '–Ω–∞–≤–æ–ª–æ—á–∫–∏'],
        '–∏–≥—Ä—É—à–∫–∏': ['–∏–≥—Ä—É—à–∫–∏', '–∫—É–∫–ª—ã', '–º–∞—à–∏–Ω–∫–∏'],
        '—ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞': ['—ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', '—Ç–µ–ª–µ—Ñ–æ–Ω', '–Ω–æ—É—Ç–±—É–∫', '–ø–ª–∞–Ω—à–µ—Ç'],
        '–ª–µ–∫–∞—Ä—Å—Ç–≤–∞': ['–ª–µ–∫–∞—Ä—Å—Ç–≤–∞', '–º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã', '—Ç–∞–±–ª–µ—Ç–∫–∏'],
        '–≤–µ—â–∏': ['–≤–µ—â–∏', '–ª–∏—á–Ω—ã–µ –≤–µ—â–∏', '–≥—Ä—É–∑']
    }

    found_type = None
    for prod_type, keywords in product_keywords.items():
        if any(keyword in text_lower for keyword in keywords):
            found_type = prod_type
            break
    if found_type:
        data['product_type'] = found_type

    return data


def extract_customs_info(text):
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–∑ —Ç–µ–∫—Å—Ç–∞ –¥–∞–Ω–Ω—ã–µ, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è —Ä–∞—Å—Ç–∞–º–æ–∂–∫–∏: —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–Ω–≤–æ–π—Å–∞ –∏ –∫–æ–¥ –¢–ù –í–≠–î.
    """
    invoice_value, tnved_code = None, None
    cost_match = re.search(r'(\d+[,.]?\d*)\s*(usd|\$|–¥–æ–ª–ª–∞—Ä)', text.lower())
    if cost_match:
        value = float(cost_match.group(1).replace(',', '.'))
        if value > 0:
            invoice_value = value

    tnved_match = re.search(r'\b(\d{10})\b', text.replace(" ", ""))
    if tnved_match:
        tnved_code = tnved_match.group(1)

    return invoice_value, tnved_code


def extract_contact_info(text):
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –∏–º—è –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.

    Returns:
        tuple: (–∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω) –∏–ª–∏ (None, None).
    """
    name, phone = None, None

    # –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å —Ç–µ–ª–µ—Ñ–æ–Ω
    validated_phone = validate_phone_number(text)
    if validated_phone:
        phone = validated_phone

    # –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å –∏–º—è (–ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ, –ø–æ—Ö–æ–∂–µ–µ –Ω–∞ –∏–º—è)
    name_match = re.search(r'([–∞-—è–ê-–Øa-zA-Z]{3,})', text)
    if name_match:
        name_candidate = name_match.group(1).lower()
        # –ò—Å–∫–ª—é—á–∞–µ–º —Å–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∏–º–µ–Ω–∞–º–∏
        if name_candidate not in ['–ø—Ä–∏–≤–µ—Ç', '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ', '–∏–Ω–≤–æ–π—Å', '–∫–∞—Ä–≥–æ', '–¥–æ—Å—Ç–∞–≤–∫–∞']:
            name = name_candidate.capitalize()


    return name, phone

# --- 8. –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –†–ê–°–ß–ï–¢–ê –°–¢–û–ò–ú–û–°–¢–ò ---
# --------------------------------------------------------------------------------------------------
# –ó–¥–µ—Å—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —è–¥—Ä–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –±–æ—Ç–∞.

def calculate_t1_rate_by_density(product_type, density):
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–∞—Ä–∏—Ñ T1 (–ö–∏—Ç–∞–π -> –ê–ª–º–∞—Ç—ã) –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ –≥—Ä—É–∑–∞ –∏ –µ–≥–æ —Ç–∏–ø–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂ (—Å—Ç–∞–≤–∫–∞, –µ–¥–∏–Ω–∏—Ü–∞_–∏–∑–º–µ—Ä–µ–Ω–∏—è), –Ω–∞–ø—Ä–∏–º–µ—Ä (1.80, 'kg') –∏–ª–∏ (230, 'm3').
    –î–ª—è –ª–µ–≥–∫–∏—Ö –≥—Ä—É–∑–æ–≤ (–Ω–∏–∑–∫–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å) —Ä–∞—Å—á–µ—Ç –∏–¥–µ—Ç –∑–∞ –∫—É–±–æ–º–µ—Ç—Ä, –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö - –∑–∞ –∫–∏–ª–æ–≥—Ä–∞–º–º.

    Args:
        product_type (str): –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞.
        density (float): –ü–ª–æ—Ç–Ω–æ—Å—Ç—å –≥—Ä—É–∑–∞ –≤ –∫–≥/–º¬≥.

    Returns:
        tuple or None: (—Å—Ç–∞–≤–∫–∞, –µ–¥–∏–Ω–∏—Ü–∞) –∏–ª–∏ None, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç.
    """
    # 1. –ú–µ–±–µ–ª—å, —Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª—ã, –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, –ø–æ—Å—É–¥–∞, –ª–∞–º–ø—ã
    if product_type in ['–º–µ–±–µ–ª—å', '—Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª—ã', '–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', '–ø–æ—Å—É–¥–∞', '–ª–∞–º–ø—ã']:
        if density >= 400: return (0.80, 'kg')
        if 350 <= density < 400: return (0.90, 'kg')
        if 300 <= density < 350: return (1.00, 'kg')
        if 250 <= density < 300: return (1.10, 'kg')
        if 200 <= density < 250: return (1.20, 'kg')
        if 190 <= density < 200: return (1.30, 'kg')
        if 180 <= density < 190: return (1.40, 'kg')
        if 170 <= density < 180: return (1.50, 'kg')
        if 160 <= density < 170: return (1.60, 'kg')
        if 150 <= density < 160: return (1.70, 'kg')
        if 140 <= density < 150: return (1.80, 'kg')
        if 130 <= density < 140: return (1.90, 'kg')
        if 120 <= density < 130: return (2.00, 'kg')
        if 110 <= density < 120: return (2.10, 'kg')
        if 100 <= density < 110: return (2.20, 'kg')
        return (230, 'm3')

    # 2. –ê–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç–∏
    if product_type == '–∞–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç–∏':
        if density >= 400: return (1.00, 'kg')
        if 350 <= density < 400: return (1.20, 'kg')
        if 300 <= density < 350: return (1.25, 'kg')
        if 250 <= density < 300: return (1.35, 'kg')
        if 200 <= density < 250: return (1.40, 'kg')
        if 190 <= density < 200: return (1.50, 'kg')
        if 180 <= density < 190: return (1.60, 'kg')
        if 170 <= density < 180: return (1.70, 'kg')
        if 160 <= density < 170: return (1.80, 'kg')
        if 150 <= density < 160: return (1.90, 'kg')
        if 140 <= density < 150: return (2.10, 'kg')
        if 130 <= density < 140: return (2.10, 'kg')
        if 120 <= density < 130: return (2.20, 'kg')
        if 110 <= density < 120: return (2.30, 'kg')
        if 100 <= density < 110: return (2.40, 'kg')
        return (240, 'm3')

    # 3. –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã, –∫–æ—Å–º–µ—Ç–∏–∫–∞, –≥–æ–ª–æ–≤–Ω—ã–µ —É–±–æ—Ä—ã, —Å—É–º–∫–∏
    if product_type in ['–∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤', '–∫–æ—Å–º–µ—Ç–∏–∫–∞', '–≥–æ–ª–æ–≤–Ω—ã–µ —É–±–æ—Ä—ã', '—Å—É–º–∫–∏']:
        if density >= 400: return (0.90, 'kg')
        if 350 <= density < 400: return (1.00, 'kg')
        if 300 <= density < 350: return (1.10, 'kg')
        if 250 <= density < 300: return (1.20, 'kg')
        if 200 <= density < 250: return (1.30, 'kg')
        if 190 <= density < 200: return (1.40, 'kg')
        if 180 <= density < 190: return (1.50, 'kg')
        if 170 <= density < 180: return (1.60, 'kg')
        if 160 <= density < 170: return (1.70, 'kg')
        if 150 <= density < 160: return (1.80, 'kg')
        if 140 <= density < 150: return (1.90, 'kg')
        if 130 <= density < 140: return (2.00, 'kg')
        if 120 <= density < 130: return (2.10, 'kg')
        if 110 <= density < 120: return (2.20, 'kg')
        if 100 <= density < 110: return (2.30, 'kg')
        return (230, 'm3')

    # 4. –ú–µ–ª–∫–∞—è –±—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞, —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞
    if product_type in ['–º–∞–ª–∞—è —Ç–µ—Ö–Ω–∏–∫–∞', '—ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', '—Ç–µ—Ö–Ω–∏–∫–∞']:
        if density >= 400: return (1.40, 'kg')
        if 300 <= density < 400: return (1.50, 'kg')
        if 200 <= density < 300: return (1.60, 'kg')
        if 190 <= density < 200: return (1.70, 'kg')
        if 180 <= density < 190: return (1.80, 'kg')
        if 170 <= density < 180: return (1.90, 'kg')
        if 160 <= density < 170: return (2.00, 'kg')
        if 150 <= density < 160: return (2.10, 'kg')
        if 140 <= density < 150: return (2.20, 'kg')
        if 130 <= density < 140: return (2.30, 'kg')
        if 120 <= density < 130: return (2.40, 'kg')
        if 110 <= density < 120: return (2.50, 'kg')
        if 100 <= density < 110: return (2.60, 'kg')
        return (270, 'm3')

    # 5. –ü—Ä–æ–¥—É–∫—Ç—ã –ø–∏—Ç–∞–Ω–∏—è, —á–∞–π
    if product_type in ['–ø—Ä–æ–¥—É–∫—Ç—ã', '—á–∞–π']:
        if density >= 300: return (1.50, 'kg')
        if 250 <= density < 300: return (1.60, 'kg')
        if 200 <= density < 250: return (1.70, 'kg')
        if 190 <= density < 200: return (1.80, 'kg')
        if 180 <= density < 190: return (1.90, 'kg')
        if 170 <= density < 180: return (2.00, 'kg')
        if 160 <= density < 170: return (2.10, 'kg')
        if 150 <= density < 160: return (2.20, 'kg')
        if 140 <= density < 150: return (2.30, 'kg')
        if 130 <= density < 140: return (2.40, 'kg')
        if 120 <= density < 130: return (2.50, 'kg')
        if 110 <= density < 120: return (2.60, 'kg')
        if 100 <= density < 110: return (2.70, 'kg')
        return (280, 'm3')

    # 6. –¢–∫–∞–Ω–∏, —Ç–µ–∫—Å—Ç–∏–ª—å, –æ–¥–µ–∂–¥–∞
    if product_type in ['—Ç–∫–∞–Ω–∏', '—Ç–µ–∫—Å—Ç–∏–ª—å', '–æ–¥–µ–∂–¥–∞']:
        if density >= 300: return (0.80, 'kg')
        if 250 <= density < 300: return (0.90, 'kg')
        if 200 <= density < 250: return (1.00, 'kg')
        if 180 <= density < 200: return (1.10, 'kg')
        if 170 <= density < 180: return (1.20, 'kg')
        if 160 <= density < 170: return (1.30, 'kg')
        if 150 <= density < 160: return (1.40, 'kg')
        if 130 <= density < 150: return (1.50, 'kg')
        if 120 <= density < 130: return (1.60, 'kg')
        if 110 <= density < 120: return (1.70, 'kg')
        if 100 <= density < 110: return (1.80, 'kg')
        return None  # –î–ª—è –Ω–∏–∑–∫–æ–π –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ —Ç–∫–∞–Ω–∏/–æ–¥–µ–∂–¥—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è —É—Ç–æ—á–Ω–µ–Ω–∏–µ

    # 7. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    if product_type == '–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã':
        if density >= 400: return (0.75, 'kg')
        if 350 <= density < 400: return (0.80, 'kg')
        if 300 <= density < 350: return (0.90, 'kg')
        if 250 <= density < 300: return (1.00, 'kg')
        if 200 <= density < 250: return (1.10, 'kg')
        if 190 <= density < 200: return (1.20, 'kg')
        if 180 <= density < 190: return (1.30, 'kg')
        if 170 <= density < 180: return (1.40, 'kg')
        if 160 <= density < 170: return (1.50, 'kg')
        if 150 <= density < 160: return (1.60, 'kg')
        if 140 <= density < 150: return (1.70, 'kg')
        if 130 <= density < 140: return (1.80, 'kg')
        if 120 <= density < 130: return (1.90, 'kg')
        if 110 <= density < 120: return (2.00, 'kg')
        if 100 <= density < 110: return (2.10, 'kg')
        return (220, 'm3')

    # 8. –ü–æ—Å—Ç–µ–ª—å–Ω–æ–µ –±–µ–ª—å–µ, –ø–æ–ª–æ—Ç–µ–Ω—Ü–∞, –æ–¥–µ—è–ª–∞
    if product_type in ['–±–µ–ª—å–µ', '–ø–æ—Å—Ç–µ–ª—å–Ω–æ–µ –±–µ–ª—å–µ', '–ø–æ–ª–æ—Ç–µ–Ω—Ü–∞', '–æ–¥–µ—è–ª–∞']:
        if density >= 180: return (1.30, 'kg')
        return None  # –¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É –¥–ª—è –Ω–∏–∑–∫–æ–π –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏

    # 9. –ò–≥—Ä—É—à–∫–∏
    if product_type == '–∏–≥—Ä—É—à–∫–∏':
        if density >= 200: return (1.50, 'kg')
        if 190 <= density < 200: return (310, 'm3')
        if 180 <= density < 190: return (300, 'm3')
        if 170 <= density < 180: return (290, 'm3')
        if 160 <= density < 170: return (280, 'm3')
        if 150 <= density < 160: return (270, 'm3')
        if 140 <= density < 150: return (260, 'm3')
        if 130 <= density < 140: return (250, 'm3')
        if 120 <= density < 130: return (240, 'm3')
        return (230, 'm3')

    # 10. –õ–µ–∫–∞—Ä—Å—Ç–≤–∞, –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã
    if product_type in ['–ª–µ–∫–∞—Ä—Å—Ç–≤–∞', '–º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã']:
        if density >= 300: return (2.90, 'kg')
        if 200 <= density < 300: return (3.00, 'kg')
        if 100 <= density < 200: return (3.10, 'kg')
        return (320, 'm3')

    # 11. –û–±—â–∏–µ —Ç–æ–≤–∞—Ä—ã, –≤–µ—â–∏ (—Ç–∞—Ä–∏—Ñ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    if density >= 400: return (2.20, 'kg')
    if 300 <= density < 400: return (2.30, 'kg')
    if 200 <= density < 300: return (2.40, 'kg')
    if 100 <= density < 200: return (2.50, 'kg')
    return (260, 'm3')


def calculate_t2_cost(weight, zone, is_fragile=False, is_village=False):
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ T2 (–ê–ª–º–∞—Ç—ã -> –ì–æ—Ä–æ–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è) –ø–æ —Ç–∞—Ä–∏—Ñ–Ω–æ–π —Å–µ—Ç–∫–µ –ö–∞–∑–ø–æ—á—Ç—ã.
    –£—á–∏—Ç—ã–≤–∞–µ—Ç –≤–µ—Å, —Ç–∞—Ä–∏—Ñ–Ω—É—é –∑–æ–Ω—É –∏ –ø–æ–≤—ã—à–∞—é—â–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –∑–∞ —Ö—Ä—É–ø–∫–æ—Å—Ç—å –∏ –¥–æ—Å—Ç–∞–≤–∫—É –≤ —Å–µ–ª–æ.

    Args:
        weight (float): –í–µ—Å –≥—Ä—É–∑–∞.
        zone (int): –¢–∞—Ä–∏—Ñ–Ω–∞—è –∑–æ–Ω–∞.
        is_fragile (bool): –§–ª–∞–≥ —Ö—Ä—É–ø–∫–æ—Å—Ç–∏.
        is_village (bool): –§–ª–∞–≥ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ —Å–µ–ª–æ.

    Returns:
        float: –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ T2.
    """
    if not validate_weight_volume(weight): return 0

    # –¢–∞—Ä–∏—Ñ—ã –∑–∞ –∫–∞–∂–¥—ã–π –ø–æ—Å–ª–µ–¥—É—é—â–∏–π –∫–≥ –ø–æ—Å–ª–µ 20 –∫–≥
    per_kg_rates = {1: 210, 2: 220, 3: 230, 4: 240, 5: 250}

    # –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞—Ä–∏—Ñ–Ω–∞—è —Å–µ—Ç–∫–∞ –¥–ª—è –≥—Ä—É–∑–æ–≤ –¥–æ 20 –∫–≥ ("–¥–æ –¥–≤–µ—Ä–∏")
    t2_under_20kg = {
        1: [(1, 2205), (2, 2310), (3, 2415), (4, 2520), (5, 2625), (6, 2730), (7, 2835), (8, 2940), (9, 3045), (10, 3150), (11, 3255), (12, 3360), (13, 3465), (14, 3570), (15, 3675), (16, 3780), (17, 3885), (18, 3990), (19, 4095), (20, 4200)],
        2: [(1, 2310), (2, 2420), (3, 2530), (4, 2640), (5, 2750), (6, 2860), (7, 2970), (8, 3080), (9, 3190), (10, 3300), (11, 3410), (12, 3520), (13, 3630), (14, 3740), (15, 3850), (16, 3960), (17, 4070), (18, 4180), (19, 4290), (20, 4400)],
        3: [(1, 2415), (2, 2530), (3, 2645), (4, 2760), (5, 2875), (6, 2990), (7, 3105), (8, 3220), (9, 3335), (10, 3450), (11, 3565), (12, 3680), (13, 3795), (14, 3910), (15, 4025), (16, 4140), (17, 4255), (18, 4370), (19, 4485), (20, 4600)],
        4: [(1, 2520), (2, 2640), (3, 2760), (4, 2880), (5, 3000), (6, 3120), (7, 3240), (8, 3360), (9, 3480), (10, 3600), (11, 3720), (12, 3840), (13, 3960), (14, 4080), (15, 4200), (16, 4320), (17, 4440), (18, 4560), (19, 4680), (20, 4800)],
        5: [(1, 2625), (2, 2750), (3, 2875), (4, 3000), (5, 3125), (6, 3250), (7, 3375), (8, 3500), (9, 3625), (10, 3750), (11, 3875), (12, 4000), (13, 4125), (14, 4250), (15, 4375), (16, 4500), (17, 4625), (18, 4750), (19, 4875), (20, 5000)]
    }

    cost = 0
    # –†–∞—Å—á–µ—Ç –¥–ª—è –≥—Ä—É–∑–æ–≤ –¥–æ 20 –∫–≥
    if weight <= 20:
        # –ü–æ–ª—É—á–∞–µ–º —Ç–∞—Ä–∏—Ñ–Ω—É—é —Å–µ—Ç–∫—É –¥–ª—è –Ω—É–∂–Ω–æ–π –∑–æ–Ω—ã, –µ—Å–ª–∏ –∑–æ–Ω—ã –Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º 3-—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        zone_rates = t2_under_20kg.get(zone, t2_under_20kg[3])
        for w_limit, rate in zone_rates:
            if weight <= w_limit:
                cost = rate
                break
    # –†–∞—Å—á–µ—Ç –¥–ª—è –≥—Ä—É–∑–æ–≤ —Å–≤—ã—à–µ 20 –∫–≥
    else:
        # –ë–µ—Ä–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ 20 –∫–≥ –∫–∞–∫ –±–∞–∑–æ–≤—É—é
        base_rate = t2_under_20kg.get(zone, t2_under_20kg[3])[-1][1]
        # –ë–µ—Ä–µ–º —Ç–∞—Ä–∏—Ñ –∑–∞ –∫–∞–∂–¥—ã–π –ø–æ—Å–ª–µ–¥—É—é—â–∏–π –∫–≥
        per_kg_rate = per_kg_rates.get(zone, 230)
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
        cost = base_rate + (weight - 20) * per_kg_rate

    # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–≤—ã—à–∞—é—â–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
    if is_fragile: cost *= 1.5
    if is_village: cost *= 2.0

    return cost

def calculate_quick_cost(weight, volume, product_type, city, exchange_rate):
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ (T1 + T2), –Ω–æ –ë–ï–ó —É—á–µ—Ç–∞ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ —Å–±–æ—Ä–∞.
    –°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–±–æ—Ä –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ–∑–∂–µ –Ω–∞ —ç—Ç–∞–ø–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞.

    Args:
        weight (float): –í–µ—Å –≥—Ä—É–∑–∞.
        volume (float): –û–±—ä–µ–º –≥—Ä—É–∑–∞.
        product_type (str): –¢–∏–ø —Ç–æ–≤–∞—Ä–∞.
        city (str): –ì–æ—Ä–æ–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.
        exchange_rate (float): –ê–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞.

    Returns:
        dict or None: –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ä–∞—Å—á–µ—Ç–∞ –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.
    """
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å
        if not all([validate_weight_volume(weight), validate_weight_volume(volume), product_type, city]):
            return None

        # –†–∞—Å—á–µ—Ç –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏
        density = weight / volume
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ T1
        t1_result = calculate_t1_rate_by_density(product_type, density)

        if t1_result is None:
            return {'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ —Ç–æ–≤–∞—Ä–∞ –∏ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏.'}

        t1_rate, unit = t1_result

        # –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ T1 –≤ USD –∏ KZT
        if unit == 'kg':
            t1_cost_usd = weight * t1_rate
            t1_description = f"{weight:.1f} –∫–≥ √ó {t1_rate:.2f} $/–∫–≥"
        else:  # unit == 'm3'
            t1_cost_usd = volume * t1_rate
            t1_description = f"{volume:.2f} –º¬≥ √ó {t1_rate:.0f} $/–º¬≥"
        t1_cost_kzt = t1_cost_usd * exchange_rate

        # –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ T2
        city_lower = city.lower()
        if city_lower in ["–∞–ª–º–∞—Ç—ã", "–∞–ª–º–∞—Ç–∞"]:
            t2_cost_kzt = 120 * weight # –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–∞—Ä–∏—Ñ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ –ê–ª–º–∞—Ç—ã
            zone = "–ê–ª–º–∞—Ç—ã"
            t2_description = f"–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É ({weight:.1f} –∫–≥)"
        else:
            zone = DESTINATION_ZONES.get(city_lower, 3) # –ó–æ–Ω–∞ 3 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            t2_cost_kzt = calculate_t2_cost(weight, zone)
            t2_description = f"–ó–æ–Ω–∞ {zone} ({weight:.1f} –∫–≥)"

        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞—Ä—è —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
        return {
            't1_cost': t1_cost_kzt,
            't2_cost': t2_cost_kzt,
            'total': t1_cost_kzt + t2_cost_kzt, # –í–∞–∂–Ω–æ: total –ë–ï–ó —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ —Å–±–æ—Ä–∞
            'zone': zone,
            'density': density,
            't1_rate': t1_rate,
            't1_unit': unit,
            't1_description': t1_description,
            't2_description': t2_description
        }
    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ 'calculate_quick_cost': {e}", exc_info=True)
        return None


def calculate_customs_cost(invoice_value, product_type, weight, exchange_rate, needs_certificate=False):
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Ç–∞–º–æ–∂–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ —Ç–∏–ø–∞ "–ò–ù–í–û–ô–°".
    """
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞–≤–∫—É –ø–æ—à–ª–∏–Ω—ã –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
        customs_rate_percent = CUSTOMS_RATES.get(product_type.lower(), 10)
        customs_rate = customs_rate_percent / 100

        # –†–∞—Å—á–µ—Ç –ø–æ—à–ª–∏–Ω—ã –∏ –ù–î–° –≤ USD
        duty_usd = invoice_value * customs_rate
        vat_usd = (invoice_value + duty_usd) * 0.12

        # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ KZT –ø–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–º—É –∫—É—Ä—Å—É
        duty_kzt = duty_usd * exchange_rate
        vat_kzt = vat_usd * exchange_rate

        # –°—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π
        total_kzt = duty_kzt + vat_kzt + CUSTOMS_FEES['–±—Ä–æ–∫–µ—Ä'] + CUSTOMS_FEES['–¥–µ–∫–ª–∞—Ä–∞—Ü–∏—è']
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞, –µ—Å–ª–∏ –æ–Ω –Ω—É–∂–µ–Ω
        if needs_certificate:
            total_kzt += CUSTOMS_FEES['—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç']

        return {
            'duty_kzt': duty_kzt,
            'vat_kzt': vat_kzt,
            'total_kzt': total_kzt,
            'customs_rate_percent': customs_rate_percent
        }
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ —Ç–∞–º–æ–∂–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π: {e}", exc_info=True)
        return None

# --- 9. –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï –° GEMINI (–ö–†–û–ú–ï –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò) ---
# --------------------------------------------------------------------------------------------------

def get_tnved_code(product_name):
    """
    –ü–æ–ª—É—á–∞–µ—Ç 10-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –¢–ù –í–≠–î –¥–ª—è —Ç–æ–≤–∞—Ä–∞ —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å Gemini.
    """
    if not customs_model:
        logger.warning("–ú–æ–¥–µ–ª—å –¢–ù–í–≠–î –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –í–æ–∑–≤—Ä–∞—â–µ–Ω –∫–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.")
        return "3926909709" # –ö–æ–¥ –¥–ª—è "–ø—Ä–æ—á–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤"
    try:
        product_name_for_prompt = product_name if product_name else "–æ–±—â–∏–µ —Ç–æ–≤–∞—Ä—ã"
        response = customs_model.generate_content(f"–ö–æ–¥ –¢–ù–í–≠–î –¥–ª—è: '{product_name_for_prompt}'")
        code = response.text.strip()
        # –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞
        if re.match(r'^\d{10}$', code):
            logger.info(f"–î–ª—è '{product_name_for_prompt}' –ø–æ–ª—É—á–µ–Ω –∫–æ–¥ –¢–ù–í–≠–î: {code}")
            return code
        else:
            logger.warning(f"Gemini –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫–æ–¥ –¢–ù–í–≠–î: '{code}'. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.")
            return "3926909709"
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–¥–∞ –¢–ù –í–≠–î: {e}")
        return "3926909709"

def check_certification_requirements(product_name):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á–µ—Ä–µ–∑ Gemini, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ —Ç–æ–≤–∞—Ä–∞.
    """
    if not main_model: # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –º–æ–¥–µ–ª—å –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        return False
    try:
        prompt = f"–î–ª—è —Ç–æ–≤–∞—Ä–∞ '{product_name}' –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –¢–† –¢–°? –û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —Å–ª–æ–≤–æ: –î–ê –∏–ª–∏ –ù–ï–¢."
        response = main_model.generate_content(prompt)
        answer = response.text.strip().upper()
        logger.info(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è '{product_name}': –û—Ç–≤–µ—Ç Gemini - '{answer}'")
        return "–î–ê" in answer
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: {e}")
        return False # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤—ã—à–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å

def get_gemini_response(user_message, context=""):
    """
    –ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Ç–≤–ª–µ—á–µ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω—É—é –º–æ–¥–µ–ª—å Gemini.
    """
    if not main_model:
        return "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è —Å–µ–π—á–∞—Å –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã. –î–∞–≤–∞–π—Ç–µ –≤–µ—Ä–Ω–µ–º—Å—è –∫ —Ä–∞—Å—á–µ—Ç—É –¥–æ—Å—Ç–∞–≤–∫–∏."
    try:
        prompt = f"–ü—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞: {context}\n\n–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_message}"
        response = main_model.generate_content(prompt)
        return response.text
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ Gemini: {e}")
        return "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –î–∞–≤–∞–π—Ç–µ –ø–æ–ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑."


# --- 10. –§–£–ù–ö–¶–ò–ò –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø –û–¢–í–ï–¢–û–í –ë–û–¢–ê ---
# --------------------------------------------------------------------------------------------------
# –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–±–∏—Ä–∞—é—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É—é—Ç –∏—Ö –≤ –∫—Ä–∞—Å–∏–≤—ã–µ,
# –ø–æ–Ω—è—Ç–Ω—ã–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è.

def get_cargo_calculation_response(delivery_data, delivery_cost, exchange_rate):
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –∫—Ä–∞—Å–∏–≤—ã–π –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–≤–µ—Ç —Å —Ä–∞—Å—á–µ—Ç–æ–º –¥–ª—è –ö–ê–†–ì–û.
    """
    density_info = f"üì¶ **–ü–ª–æ—Ç–Ω–æ—Å—Ç—å –≥—Ä—É–∑–∞:** {delivery_cost['density']:.1f} –∫–≥/–º¬≥"
    t1_basis_info = f"üí° *–¢–∞—Ä–∏—Ñ –¢1 ({delivery_cost['t1_description']}) —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –∑–∞ {'**–æ–±—ä–µ–º (–º¬≥)**, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –≤—ã–≥–æ–¥–Ω–µ–µ –¥–ª—è –ª–µ–≥–∫–æ–≥–æ –≥—Ä—É–∑–∞' if delivery_cost['t1_unit'] == 'm3' else '**–≤–µ—Å (–∫–≥)**'}*"
    
    cost_t1_with_service = delivery_cost['t1_cost'] * 1.20
    cost_t1_t2_with_service = (delivery_cost['t1_cost'] + delivery_cost['t2_cost']) * 1.20
    
    return (
        f"üìä **–†–∞—Å—á–µ—Ç –¥–ª—è –ö–ê–†–ì–û –¥–æ—Å—Ç–∞–≤–∫–∏:**\n\n"
        f"‚úÖ **–¢–æ–≤–∞—Ä:** {delivery_data['weight']} –∫–≥ ¬´{delivery_data['product_type']}¬ª\n"
        f"‚úÖ **–û–±—ä–µ–º:** {delivery_data.get('volume', 'N/A'):.2f} –º¬≥ {f'({delivery_data.get(\"dimensions_str\", \"\")})' if delivery_data.get('dimensions_str') else ''}\n"
        f"‚úÖ **–ì–æ—Ä–æ–¥:** {delivery_data['city'].capitalize()}\n"
        f"‚úÖ {density_info}\n\n"
        f"*{t1_basis_info}*\n\n"
        f"--- \n"
        f"üè∑Ô∏è **–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –¥–æ—Å—Ç–∞–≤–∫–∏:**\n\n"
        f"**üöö –í–ê–†–ò–ê–ù–¢ 1: –î–û–°–¢–ê–í–ö–ê –î–û –ê–õ–ú–ê–¢–´ (–¢1)**\n"
        f"‚Ä¢ **–û–ø–∏—Å–∞–Ω–∏–µ:** –î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –Ω–∞—à–µ–≥–æ —Å–∫–ª–∞–¥–∞ –≤ –≥. –ê–ª–º–∞—Ç—ã (–¥–ª—è —Å–∞–º–æ–≤—ã–≤–æ–∑–∞).\n"
        f"‚Ä¢ **–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏:** {delivery_cost['t1_cost']:,.0f} ‚Ç∏\n"
        f"‚Ä¢ **–°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–±–æ—Ä (20%):** {delivery_cost['t1_cost'] * 0.20:,.0f} ‚Ç∏\n"
        f"üí∞ **–ò–¢–û–ì–û: {cost_t1_with_service:,.0f} ‚Ç∏**\n\n"
        f"**üè† –í–ê–†–ò–ê–ù–¢ 2: –î–û–°–¢–ê–í–ö–ê –î–û –î–í–ï–†–ò (–¢1+–¢2)**\n"
        f"‚Ä¢ **–û–ø–∏—Å–∞–Ω–∏–µ:** –î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –≤–∞—à–µ–≥–æ –∞–¥—Ä–µ—Å–∞ –≤ –≥. {delivery_data['city'].capitalize()}.\n"
        f"‚Ä¢ **–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏:** {(delivery_cost['t1_cost'] + delivery_cost['t2_cost']):,.0f} ‚Ç∏\n"
        f"‚Ä¢ **–°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–±–æ—Ä (20%):** {(delivery_cost['t1_cost'] + delivery_cost['t2_cost']) * 0.20:,.0f} ‚Ç∏\n"
        f"üí∞ **–ò–¢–û–ì–û: {cost_t1_t2_with_service:,.0f} ‚Ç∏**\n\n"
        f"--- \n"
        f"üìà *–†–∞—Å—á–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –ø–æ –∫—É—Ä—Å—É –ù–ë –†–ö –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: {exchange_rate:.2f} ‚Ç∏ –∑–∞ 1 USD.*\n\n"
        f"üí° **–ù–∞–ø–∏—à–∏—Ç–µ `1` –∏–ª–∏ `2`, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç.**"
    )

def get_customs_full_calculation(delivery_data, customs_data, tnved_code, exchange_rate):
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å –ø–æ–ª–Ω—ã–º —Ä–∞—Å—á–µ—Ç–æ–º –¥–ª—è –ò–ù–í–û–ô–°, –≤–∫–ª—é—á–∞—è —Ç–∞–º–æ–∂–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏.
    """
    delivery_cost = calculate_quick_cost(delivery_data['weight'], delivery_data['volume'], delivery_data['product_type'], delivery_data['city'], exchange_rate)
    if not delivery_cost or delivery_cost.get('error'):
        return "‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏. " + (delivery_cost.get('error') or "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.")
    
    needs_certification = check_certification_requirements(delivery_data['product_type'])
    customs_cost = calculate_customs_cost(customs_data['invoice_value'], delivery_data['product_type'], delivery_data['weight'], exchange_rate, needs_certification)
    if not customs_cost:
        return "‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Ç–∞–º–æ–∂–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π."
    
    t1_total = delivery_cost['t1_cost'] * 1.20 + customs_cost['total_kzt']
    t2_total = (delivery_cost['t1_cost'] + delivery_cost['t2_cost']) * 1.20 + customs_cost['total_kzt']
    
    return (
        f"üìä **–†–∞—Å—á–µ—Ç –¥–ª—è –ò–ù–í–û–ô–°:**\n\n"
        f"‚úÖ **–¢–æ–≤–∞—Ä:** {delivery_data['weight']} –∫–≥ ¬´{delivery_data['product_type']}¬ª –≤ –≥. {delivery_data['city'].capitalize()}\n"
        f"‚úÖ **–¢–∞–º–æ–∂–µ–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:** {customs_data['invoice_value']:,.2f} USD\n"
        f"‚úÖ **–ö–æ–¥ –¢–ù–í–≠–î:** {tnved_code}\n\n"
        f"--- \n"
        f"üè∑Ô∏è **–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –¥–æ—Å—Ç–∞–≤–∫–∏:**\n\n"
        f"**üöö –í–ê–†–ò–ê–ù–¢ 1: –î–û–°–¢–ê–í–ö–ê –î–û –ê–õ–ú–ê–¢–´ (–¢1)**\n"
        f"‚Ä¢ **–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å, –≤–∫–ª—é—á–∞—è –¥–æ—Å—Ç–∞–≤–∫—É –¥–æ –ê–ª–º–∞—Ç—ã –∏ –≤—Å–µ —Ç–∞–º–æ–∂–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏.\n"
        f"üí∞ **–ò–¢–û–ì–û –ü–û–î –ö–õ–Æ–ß: {t1_total:,.0f} ‚Ç∏**\n\n"
        f"**üè† –í–ê–†–ò–ê–ù–¢ 2: –î–û–°–¢–ê–í–ö–ê –î–û –î–í–ï–†–ò (–¢1+–¢2)**\n"
        f"‚Ä¢ **–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å, –≤–∫–ª—é—á–∞—è –¥–æ—Å—Ç–∞–≤–∫—É –¥–æ –≤–∞—à–µ–≥–æ –∞–¥—Ä–µ—Å–∞ –∏ –≤—Å–µ —Ç–∞–º–æ–∂–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏.\n"
        f"üí∞ **–ò–¢–û–ì–û –ü–û–î –ö–õ–Æ–ß: {t2_total:,.0f} ‚Ç∏**\n\n"
        f"--- \n"
        f"üìÑ **–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** {'—Ç—Ä–µ–±—É–µ—Ç—Å—è' if needs_certification else '–Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è'}\n"
        f"üìà *–†–∞—Å—á–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –ø–æ –∫—É—Ä—Å—É –ù–ë –†–ö –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: {exchange_rate:.2f} ‚Ç∏ –∑–∞ 1 USD.*\n\n"
        f"üí° **–ù–∞–ø–∏—à–∏—Ç–µ `1` –∏–ª–∏ `2` —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç.**"
    )

def show_final_calculation(delivery_data, customs_data, delivery_option, exchange_rate):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –≤–∞—Ä–∏–∞–Ω—Ç –¥–æ—Å—Ç–∞–≤–∫–∏.
    """
    delivery_cost = calculate_quick_cost(delivery_data['weight'], delivery_data['volume'], delivery_data['product_type'], delivery_data['city'], exchange_rate)
    if not delivery_cost or delivery_cost.get('error'): return "‚ùå –û—à–∏–±–∫–∞ –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞."

    if delivery_data['delivery_type'] == 'CARGO':
        total_cost = delivery_cost['t1_cost'] * 1.20 if delivery_option == "—Å–∞–º–æ–≤—ã–≤–æ–∑" else (delivery_cost['t1_cost'] + delivery_cost['t2_cost']) * 1.20
    else: # INVOICE
        customs_cost_data = calculate_customs_cost(customs_data['invoice_value'], delivery_data['product_type'], delivery_data['weight'], exchange_rate)
        total_delivery = delivery_cost['t1_cost'] * 1.20 if delivery_option == "—Å–∞–º–æ–≤—ã–≤–æ–∑" else (delivery_cost['t1_cost'] + delivery_cost['t2_cost']) * 1.20
        total_cost = total_delivery + customs_cost_data['total_kzt']

    return (
        f"‚úÖ **–û—Ç–ª–∏—á–Ω–æ! –í—ã–±—Ä–∞–Ω –≤–∞—Ä–∏–∞–Ω—Ç: –î–û–°–¢–ê–í–ö–ê –î–û {'–î–í–ï–†–ò' if delivery_option == '–¥–æ –¥–≤–µ—Ä–∏' else '–ê–õ–ú–ê–¢–´ (—Å–∞–º–æ–≤—ã–≤–æ–∑)'}**\n\n"
        f"üí∞ **–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: {total_cost:,.0f} ‚Ç∏**\n"
        f"‚è±Ô∏è –ü—Ä–∏–º–µ—Ä–Ω—ã–π —Å—Ä–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏: 12-15 –¥–Ω–µ–π\n\n"
        f"üíé **–ï—Å–ª–∏ –≤–∞—Å –≤—Å–µ —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç, –¥–∞–≤–∞–π—Ç–µ –æ—Ñ–æ—Ä–º–∏–º –∑–∞—è–≤–∫—É!**\n"
        f"üìù –î–ª—è —ç—Ç–æ–≥–æ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ **–∏–º—è –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞** (–Ω–∞–ø—Ä–∏–º–µ—Ä: `–ê–π–¥–æ—Å, 87051234567`)"
    )

# --- 11. –ü–†–û–ß–ò–ï –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
# --------------------------------------------------------------------------------------------------

def get_missing_data(delivery_data, customs_data, delivery_type):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∫–∞–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–∞, –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Ö —Å–ø–∏—Å–æ–∫.
    """
    missing = []
    if not validate_weight_volume(delivery_data.get('weight')):
        missing.append("–≤–µ—Å –≥—Ä—É–∑–∞ (–≤ –∫–≥)")
    if not validate_weight_volume(delivery_data.get('volume')):
        missing.append("–æ–±—ä–µ–º –≥—Ä—É–∑–∞ (–≤ –º¬≥) –∏–ª–∏ –≥–∞–±–∞—Ä–∏—Ç—ã (–î√ó–®√ó–í –≤ —Å–º)")
    if not delivery_data.get('product_type'):
        missing.append("—Ç–∏–ø —Ç–æ–≤–∞—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –æ–¥–µ–∂–¥–∞, —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞)")
    if not delivery_data.get('city'):
        missing.append("–≥–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ")

    if delivery_type == 'INVOICE':
        if not (customs_data.get('invoice_value') and customs_data.get('invoice_value') > 0):
            missing.append("—Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–æ–≤ –≤ USD")
        # –¢–ù–í–≠–î –∫–æ–¥ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω, —Ç.–∫. –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        # if not customs_data.get('tnved_code'):
        #     missing.append("–∫–æ–¥ –¢–ù–í–≠–î")
    return missing

def save_application(details):
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–µ—Ç–∞–ª–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω–æ–π –∑–∞—è–≤–∫–∏ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª "applications.txt".
    """
    try:
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        log_entry = f"–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞: {timestamp}\n{details}\n"
        with open("applications.txt", "a", encoding="utf-8") as f:
            f.write("="*60 + "\n" + log_entry + "="*60 + "\n\n")
        logger.info(f"–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {details.splitlines()[0]}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –≤ —Ñ–∞–π–ª: {e}")

# --- 12. –ì–õ–ê–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (FLASK ROUTES) ---
# --------------------------------------------------------------------------------------------------
# –≠—Ç–æ —Å–µ—Ä–¥—Ü–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –≥–¥–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

@app.route('/', methods=['GET'])
def index():
    """
    –†–µ–Ω–¥–µ—Ä–∏—Ç –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–∞—Ç–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–µ—Å—Å–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    # –û—á–∏—Å—Ç–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å–µ—Å—Å–∏–∏
    session.clear()
    session['delivery_data'] = {}
    session['customs_data'] = {}
    session['chat_history'] = []
    # –í–≤–æ–¥–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏—è: initial, gathering, calculated, ordering
    session['state'] = 'initial'
    logger.info(f"–ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è {session.sid} —Å–æ–∑–¥–∞–Ω–∞.")

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    if main_model is None:
        initialize_models()

    return render_template('index.html')


@app.route('/chat', methods=['POST'])
def chat():
    """
    –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–∏–∞–ª–æ–≥–∞.
    """
    try:
        user_message = request.json.get('message', '').strip()
        if not user_message:
            return jsonify({"response": "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."})

        # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å–µ—Å—Å–∏–∏
        delivery_data = session.get('delivery_data', {})
        customs_data = session.get('customs_data', {})
        chat_history = session.get('chat_history', [])
        state = session.get('state', 'initial')

        chat_history.append(f"–ö–ª–∏–µ–Ω—Ç: {user_message}")
        logger.info(f"–°–µ—Å—Å–∏—è {session.sid} | –°–æ—Å—Ç–æ—è–Ω–∏–µ: {state} | –°–æ–æ–±—â–µ–Ω–∏–µ: '{user_message}'")

        # --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã —Å–±—Ä–æ—Å–∞ –≤ –ª—é–±–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ ---
        if user_message.lower() in ['/start', '—Å–±—Ä–æ—Å', '—Å—Ç–∞—Ä—Ç', '–Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ', '–Ω–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç']:
            session.clear()
            logger.info(f"–°–µ—Å—Å–∏—è {session.sid} —Å–±—Ä–æ—à–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
            response_text = ("üöö **–î–∏–∞–ª–æ–≥ —Å–±—Ä–æ—à–µ–Ω. –ù–∞—á–Ω–µ–º –∑–∞–Ω–æ–≤–æ!**\n\n"
                           "–Ø –ø–æ–º–æ–≥—É –≤–∞–º —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ –∏–∑ –ö–∏—Ç–∞—è –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω.\n\n"
                           "üí° **–î–ª—è —Ä–∞—Å—á–µ—Ç–∞ —É–∫–∞–∂–∏—Ç–µ:**\n"
                           "‚Ä¢ –í–µ—Å –≥—Ä—É–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: `50 –∫–≥`)\n"
                           "‚Ä¢ –û–±—ä–µ–º (–º¬≥) –∏–ª–∏ –≥–∞–±–∞—Ä–∏—Ç—ã (`120—Ö80—Ö60 —Å–º`)\n"
                           "‚Ä¢ –¢–∏–ø —Ç–æ–≤–∞—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: `–æ–¥–µ–∂–¥–∞`)\n"
                           "‚Ä¢ –ì–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ")
            session['state'] = 'initial'
            return jsonify({"response": response_text})

        # --- –õ–æ–≥–∏–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞ ---

        # –°–æ—Å—Ç–æ—è–Ω–∏–µ 1: –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞
        if state == 'calculated':
            if is_delivery_choice(user_message):
                delivery_option = parse_delivery_choice(user_message)
                delivery_data['delivery_option'] = delivery_option
                session['delivery_data'] = delivery_data
                current_rate = session.get('current_exchange_rate', 450.0)
                response = show_final_calculation(delivery_data, customs_data, delivery_option, current_rate)
                state = 'ordering' # –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
            else:
                response = get_gemini_response(user_message, "–ö–ª–∏–µ–Ω—Ç –∑–∞–¥–∞–µ—Ç –æ—Ç–≤–ª–µ—á–µ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å. –û—Ç–≤–µ—Ç—å –∫—Ä–∞—Ç–∫–æ –∏ –≤–µ–∂–ª–∏–≤–æ, –∞ –∑–∞—Ç–µ–º –Ω–∞—Å—Ç–æ–π—á–∏–≤–æ –Ω–∞–ø–æ–º–Ω–∏ –≤—ã–±—Ä–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –¥–æ—Å—Ç–∞–≤–∫–∏, –Ω–∞–ø–∏—Å–∞–≤ '1' –∏–ª–∏ '2'.")
        
        # –°–æ—Å—Ç–æ—è–Ω–∏–µ 2: –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
        elif state == 'ordering':
            name, phone = extract_contact_info(user_message)
            if name and phone:
                app_details = (
                    f"–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏: {delivery_data.get('delivery_type', 'N/A')}\n"
                    f"–í–µ—Å: {delivery_data.get('weight')} –∫–≥\n"
                    f"–û–±—ä–µ–º: {delivery_data.get('volume'):.2f} –º¬≥\n"
                    f"–¢–æ–≤–∞—Ä: {delivery_data.get('product_type')}\n"
                    f"–ì–æ—Ä–æ–¥: {delivery_data.get('city')}\n"
                    f"–í—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: {delivery_data.get('delivery_option')}\n"
                    f"–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞: {name}\n"
                    f"–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞: {phone}\n"
                )
                if delivery_data.get('delivery_type') == 'INVOICE':
                    app_details += (f"–°—Ç–æ–∏–º–æ—Å—Ç—å –∏–Ω–≤–æ–π—Å–∞: {customs_data.get('invoice_value')} USD\n"
                                    f"–ö–æ–¥ –¢–ù–í–≠–î: {customs_data.get('tnved_code', '–Ω–µ —É–∫–∞–∑–∞–Ω')}\n")
                save_application(app_details)
                response = f"‚úÖ **–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!**\n\n{name}, –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –ø–æ –Ω–æ–º–µ—Ä—É `{phone}` –≤ –±–ª–∏–∂–∞–π—à–µ–µ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π.\n\n–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –≤—ã–±—Ä–∞–ª–∏ PostPro! üöö\n\nüîÑ *–î–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞–ø–∏—à–∏—Ç–µ ¬´—Å—Ç–∞—Ä—Ç¬ª*"
                state = 'finished' # –î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à–µ–Ω
            else:
                response = "‚ùå **–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã.**\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ **–∏–º—è –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞** –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏. –ù–∞–ø—Ä–∏–º–µ—Ä: `–ú–∞—Ä–∏—è, 77071234567`"
        
        # –°–æ—Å—Ç–æ—è–Ω–∏–µ 3: –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏ –ø–µ—Ä–≤–∏—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
        else: # state == 'initial' or 'gathering'
            extracted_delivery = extract_delivery_info(user_message)
            delivery_data.update(extracted_delivery)
            
            extracted_customs_val, extracted_tnved = extract_customs_info(user_message)
            if extracted_customs_val: customs_data['invoice_value'] = extracted_customs_val
            if extracted_tnved: customs_data['tnved_code'] = extracted_tnved
            
            if not delivery_data.get('delivery_type'):
                delivery_data['delivery_type'] = 'INVOICE' if customs_data.get('invoice_value') or '–∏–Ω–≤–æ–π—Å' in user_message.lower() else 'CARGO'
            
            missing_data = get_missing_data(delivery_data, customs_data, delivery_data['delivery_type'])
            
            if missing_data:
                response = f"üìã –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ: **{', '.join(missing_data)}**"
                state = 'gathering'
            else:
                # –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—Ä–∞–Ω—ã, –≤—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞—Å—á–µ—Ç
                current_rate = get_current_exchange_rate()
                session['current_exchange_rate'] = current_rate
                
                if delivery_data['delivery_type'] == 'CARGO':
                    delivery_cost = calculate_quick_cost(delivery_data['weight'], delivery_data['volume'], delivery_data['product_type'], delivery_data['city'], current_rate)
                    if delivery_cost and not delivery_cost.get('error'):
                        response = get_cargo_calculation_response(delivery_data, delivery_cost, current_rate)
                        state = 'calculated'
                    else:
                        response = "‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞. " + (delivery_cost.get('error') or "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
                
                else: # INVOICE
                    if not customs_data.get('tnved_code'):
                         if doesnt_know_tnved(user_message):
                            tnved_code = get_tnved_code(delivery_data['product_type'])
                            customs_data['tnved_code'] = tnved_code
                            response = get_customs_full_calculation(delivery_data, customs_data, tnved_code, current_rate)
                            state = 'calculated'
                         else:
                            response = "üìã **–î–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ò–ù–í–û–ô–°–ê —É–∫–∞–∂–∏—Ç–µ –∫–æ–¥ –¢–ù–í–≠–î.**\n\n–ï—Å–ª–∏ –≤—ã –Ω–µ –∑–Ω–∞–µ—Ç–µ –∫–æ–¥, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ `–Ω–µ –∑–Ω–∞—é`, –∏ —è –æ–ø—Ä–µ–¥–µ–ª—é –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
                            state = 'gathering' # –û—Å—Ç–∞–µ–º—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
                    else:
                        response = get_customs_full_calculation(delivery_data, customs_data, customs_data['tnved_code'], current_rate)
                        state = 'calculated'

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –∏—Å—Ç–æ—Ä–∏–∏ –≤ —Å–µ—Å—Å–∏—é
        session['delivery_data'] = delivery_data
        session['customs_data'] = customs_data
        session['chat_history'] = chat_history
        session['state'] = state
        
        chat_history.append(f"–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: {response}")
        logger.info(f"–°–µ—Å—Å–∏—è {session.sid} | –û—Ç–≤–µ—Ç: '{response[:150].replace('\n', ' ')}...'")
        
        return jsonify({"response": response})

    except Exception as e:
        logger.critical(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ /chat: {e}", exc_info=True)
        return jsonify({"response": "–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ä—å–µ–∑–Ω–∞—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ, –Ω–∞–ø–∏—Å–∞–≤ ¬´—Å—Ç–∞—Ä—Ç¬ª."})


@app.route('/clear', methods=['POST'])
def clear_chat():
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–±—Ä–æ—Å–∞ —Å–µ—Å—Å–∏–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞.
    """
    session.clear()
    logger.info(f"–°–µ—Å—Å–∏—è {session.sid} –æ—á–∏—â–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–æ–º.")
    return jsonify({"status": "success"})


# --- 13. –¢–û–ß–ö–ê –í–•–û–î–ê –î–õ–Ø –ó–ê–ü–£–°–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
# --------------------------------------------------------------------------------------------------

if __name__ == '__main__':
    """
    –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –º–æ–¥–µ–ª–∏ –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤–µ–±-—Å–µ—Ä–≤–µ—Ä Flask.
    –°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –≤—Å–µ–º —Å–µ—Ç–µ–≤—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º –Ω–∞ –ø–æ—Ä—Ç—É 5000.
    """
    if initialize_models():
        try:
            hostname = socket.gethostname()
            local_ip = socket.gethostbyname(hostname)
            logger.info("=" * 60)
            logger.info("           POSTPRO CHATBOT –£–°–ü–ï–®–ù–û –ó–ê–ü–£–©–ï–ù")
            logger.info("           –í–ï–†–°–ò–Ø: 3.0.0 (–° –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ú –ö–£–†–°–û–ú)")
            logger.info("=" * 60)
            logger.info(f"  -> –õ–æ–∫–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø: http://localhost:5000")
            logger.info(f"  -> –°–µ—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø:   http://{local_ip}:5000")
            logger.info("-" * 60)
            # debug=True –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Å–ª–µ–¥—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ False
            app.run(host='0.0.0.0', port=5000, debug=True)
        except Exception as e:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å Flask —Å–µ—Ä–≤–µ—Ä: {e}")
    else:
        logger.error("!!! –ó–ê–ü–£–°–ö –ù–ï–í–û–ó–ú–û–ñ–ï–ù: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª–∏ Gemini.")
# --- –ö–û–ù–ï–¶ –§–ê–ô–õ–ê ---
